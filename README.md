# 🤖 Discord 氣象地震交通機器人

一個功能完整的 Discord 機器人，提供台灣地區的地震資訊、天氣預報、氣象站觀測資料、水利防災影像以及公路監視器查詢服務。

## ✨ 主要功能

### 🔔 地震監控
- **即時地震通知**: 自動監控中央氣象署地震資料，即時推送最新地震資訊
- **地震資訊查詢**: 支援一般地震和小區域地震資料查詢
- **詳細震度資訊**: 提供震央位置、規模、深度及各地震度分布

### 🌤️ 天氣服務
- **天氣預報查詢**: 支援全台各縣市 36 小時天氣預報
- **互動式選單**: 使用下拉選單快速選擇查詢地區
- **詳細氣象資訊**: 包含溫度、濕度、降雨機率、風速等完整資訊

### 🌡️ 氣象站觀測
- **即時觀測資料**: 查詢全台 500+ 個自動氣象站的即時觀測資料
- **多種查詢模式**: 支援全台概況、地區查詢、單一測站詳細資料
- **翻頁瀏覽功能**: 當查詢結果過多時，提供翻頁按鈕便於瀏覽
- **重新整理功能**: 可即時更新最新的觀測資料

### 💧 水利防災影像 (新功能)
- **監控影像查詢**: 查詢全台 170+ 個水利防災監控點影像
- **地區搜尋**: 支援縣市名稱或監控站名稱搜尋
- **即時影像顯示**: 提供即時的河川、水位監控影像
- **詳細位置資訊**: 顯示監控點位置、河川名稱、運作狀態等

### 🛣️ 公路監視器查詢 (新功能)
- **國道監視器**: 專門查詢國道 1、3、5、6、8、10 號監視器
- **快速公路/省道監視器**: 查詢台62、台64等快速公路及省道監視器
- **智能道路分類**: 自動區分國道、快速公路、省道等道路類型
- **即時路況影像**: 提供即時的道路交通狀況影像

### 🏞️ 水庫水情查詢
- **水庫資訊**: 查詢全台主要水庫的蓄水量、水位等資訊
- **即時水情**: 提供最新的水庫營運狀態

### 🌊 海嘯警報
- **海嘯資訊監控**: 查詢最新海嘯警報和相關資訊

## 🎮 指令列表

### 氣象地震類
| 指令 | 描述 | 參數 |
|------|------|------|
| `/earthquake` | 查詢最新地震資訊 | `type`: "normal" 或 "small" |
| `/weather` | 查詢天氣預報 | `location`: 縣市名稱 (可選) |
| `/weather_station` | 查詢氣象站觀測資料 | `station_id`: 測站代碼 (可選)<br>`location`: 地區名稱 (可選) |
| `/tsunami` | 查詢海嘯資訊 | 無 |

### 水利防災類
| 指令 | 描述 | 參數 |
|------|------|------|
| `/water_cameras` | 查詢水利防災監控影像 | `location`: 地區名稱 (可選) |
| `/reservoir_info` | 查詢水庫資訊 | `reservoir_id`: 水庫代碼 (可選) |
| `/water_level` | 查詢即時水位資訊 | 無 |

### 交通監控類
| 指令 | 描述 | 參數 |
|------|------|------|
| `/national_highway_cameras` | 查詢國道監視器影像 | `highway_number`: 國道號碼 (如：1、3、5)<br>`location`: 地點 (可選)<br>`direction`: 方向 (可選)<br>`city`: 縣市 (可選) |
| `/general_road_cameras` | 查詢快速公路/省道監視器 | `road_name`: 道路名稱 (如：台62、台1)<br>`location`: 地點 (可選)<br>`direction`: 方向 (可選)<br>`city`: 縣市 (可選) |

### 管理類
| 指令 | 描述 | 權限要求 |
|------|------|----------|
| `/set_earthquake_channel` | 設定地震通知頻道 | 管理員權限 |

## 🚀 快速開始

### 環境需求
- Python 3.8+
- Discord.py 2.3+
- aiohttp
- xmltodict
- ssl (用於 HTTPS 連線)

### 安裝步驟

1. **克隆專案**
   ```bash
   git clone [repository-url]
   cd Discord-bot
   ```

2. **安裝依賴**
   ```bash
   pip install -r requirements.txt
   ```

3. **設定環境變數**
   ```bash
   cp .env.example .env
   # 編輯 .env 檔案，填入您的 Discord Bot Token
   ```

4. **啟動機器人**
   ```bash
   python bot.py
   ```

## 🎯 功能使用範例

### 水利防災影像查詢
```
/water_cameras                          # 查看全台監控點分布
/water_cameras location:台北             # 查看台北地區監控影像
/water_cameras location:台南溪頂寮大橋    # 查看特定監控點影像
```

### 公路監視器查詢
```
/national_highway_cameras highway_number:1              # 查看國道1號監視器
/national_highway_cameras highway_number:3 city:台中    # 查看國道3號台中段
/general_road_cameras road_name:台62                   # 查看台62快速公路
/general_road_cameras road_name:台1 location:基隆      # 查看台1線基隆段
```

### 氣象站查詢
```
/weather_station                        # 顯示全台主要縣市概況
/weather_station location:台北           # 查詢台北地區所有氣象站
/weather_station station_id:466920      # 查詢特定測站 (台北)4. **啟動機器人**
   ```bash
   python bot.py
   ```

## 🔧 配置說明

### Discord Bot 設定
1. 前往 [Discord Developer Portal](https://discord.com/developers/applications)
2. 創建新的應用程式和機器人
3. 取得 Bot Token 並設定在 `.env` 檔案中
4. 確保機器人具有以下權限：
   - Send Messages
   - Use Slash Commands
   - Embed Links
   - Read Message History
   - Attach Files

### API 設定
本機器人使用以下官方開放資料 API，無需額外申請 API Key：
- 中央氣象署開放資料 API
- 經濟部水利署防災資訊 API
- 交通部高速公路局 CCTV API

## 📁 專案結構

```
Discord bot/
├── bot.py                              # 主程式入口
├── cogs/
│   ├── info_commands_fixed_v4_clean.py # 氣象地震功能
│   └── reservoir_commands.py          # 水利交通功能
├── tests/                              # 測試檔案目錄
│   ├── test_bot_loading.py            # Bot 載入測試
│   ├── simple_function_test.py        # 基本功能測試
│   ├── final_verification.py          # 最終驗證測試
│   ├── test_weather_station_pagination.py # 翻頁功能測試
│   ├── test_water_cameras_fix.py      # 水利影像修復測試
│   └── final_core_functionality_test.py # 核心功能測試
├── scripts/                            # 輔助腳本
├── docs/                              # 說明文件
├── config_files/                      # 設定檔案
├── .env                               # 環境變數 (需自行創建)
├── .env.example                       # 環境變數範例
└── requirements.txt                   # Python 依賴清單
```

## 🎯 道路分類系統詳解

### 智能道路分類
機器人採用智能演算法自動分類不同類型的道路：

#### 🛣️ 國道 (National Highway)
- **範圍**: 國道 1、3、5、6、8、10 號
- **特徵**: 高速公路系統，連接主要都市
- **查詢**: 使用 `/national_highway_cameras`

#### 🚗 快速公路 (Expressway)  
- **範圍**: 台62、台64、台68、台72、台74、台76、台78、台82、台84、台86、台88線
- **特徵**: 快速道路系統，多為都會區連絡道路
- **查詢**: 使用 `/general_road_cameras`

#### 🛤️ 省道 (Provincial Highway)
- **範圍**: 台1、台2、台3、台9、台11、台17、台19等
- **特徵**: 縱橫幹線道路，連接各縣市
- **查詢**: 使用 `/general_road_cameras`

### 分類優先級
1. **快速公路優先**: 避免台62、台64被誤分類為國道
2. **國道識別**: 基於道路編號和描述關鍵字
3. **省道識別**: 台X線格式，排除快速公路
4. **一般道路**: 其他未分類道路

## 🧪 測試系統

### 執行完整測試套件
```bash
# 核心功能測試
python final_core_functionality_test.py

# 水利影像修復測試  
python test_water_cameras_fix.py

# 道路分類測試
python diagnose_highway_classification.py
```

### 測試涵蓋範圍
- ✅ 水利防災影像 KeyError 修復驗證
- ✅ 道路分類準確性測試 (準確率 100%)
- ✅ API 連線狀態檢查
- ✅ 資料格式化完整性驗證
- ✅ 翻頁功能測試
- ✅ Bot 載入和權限測試

## 📊 API 資料來源

### 氣象地震類
- **地震資料**: 中央氣象署地震報告 API
- **天氣預報**: 中央氣象署天氣預報 API  
- **氣象站資料**: 中央氣象署自動氣象站觀測資料 API
- **海嘯資料**: 中央氣象署海嘯資訊 API

### 水利防災類
- **水利防災影像**: 經濟部水利署防災資訊 API (171個監控點)
- **水庫資訊**: 經濟部水利署水庫即時水情 API
- **水位資料**: 水利署水位觀測 API

### 交通監控類
- **公路監視器**: 交通部高速公路局 CCTV API
- **即時路況**: 公路總局路況資訊 API

## 🛠️ 開發功能

### ✅ 已實現功能
- ✅ 地震監控和通知系統
- ✅ 天氣預報查詢
- ✅ 氣象站觀測資料查詢
- ✅ 翻頁瀏覽功能
- ✅ 海嘯警報查詢
- ✅ **水利防災影像查詢** (新功能)
- ✅ **公路監視器查詢** (新功能)
- ✅ **智能道路分類系統** (新功能)
- ✅ 水庫水情查詢
- ✅ 自動重新整理
- ✅ 用戶權限控制
- ✅ 錯誤處理和重試機制

### 🔧 最新修復
- ✅ **水利防災影像 KeyError 修復** (2025-06-29)
- ✅ **國道與快速公路分類優化** (2025-06-29)
- ✅ **監視器查詢指令分離** (2025-06-29)
- ✅ **format_water_image_info 回傳欄位完整化** (2025-06-29)

### 🎯 技術特色
- **異步處理**: 使用 asyncio 和 aiohttp 提升效能
- **模組化設計**: 使用 Discord.py Cogs 系統
- **智能快取**: 減少 API 調用次數
- **容錯機制**: 完整的錯誤處理和自動重試
- **用戶體驗**: 友善的互動介面和即時回應
- **智能分類**: 自動道路類型識別系統
- **多元查詢**: 支援地區、編號、關鍵字等多種搜尋方式

## 📝 更新日誌

### v5.0 (2025-06-30) 🎉 重大更新
- ✨ **新增水利防災影像查詢功能**
  - 支援全台 171 個水利防災監控點查詢
  - 地區搜尋和特定監控站查詢
  - 即時河川、水位監控影像顯示
- ✨ **新增公路監視器查詢系統**
  - 國道監視器專用查詢 (`/national_highway_cameras`)
  - 快速公路/省道監視器查詢 (`/general_road_cameras`)
  - 智能道路分類系統，準確率 100%
- 🔧 **修復水利防災影像 KeyError 問題**
  - 完善 `format_water_image_info` 函數回傳結構
  - 新增 county、district、address、station_id、source 欄位
- 🔧 **優化道路分類演算法**
  - 快速公路優先判斷，避免誤分類為國道
  - 台62、台64 等快速公路正確分類
- ✨ **新增水庫水情查詢功能**
  - 支援全台主要水庫即時水情查詢
  - 蓄水量、水位等詳細資訊顯示
- 📁 **完善測試系統**
  - 新增核心功能驗證測試
  - 水利影像修復專用測試
  - 道路分類準確性測試

### v4.0 (2025-06-25)
- ✨ 新增氣象站觀測資料查詢功能
- ✨ 實現翻頁瀏覽系統
- 🔧 修復地震功能的資料結構問題
- 📁 重新整理測試檔案結構
- 📖 完善說明文件

### v3.x
- 修復地震 API 相關問題
- 改善天氣預報功能
- 新增海嘯警報功能

## 🤝 貢獻指南

1. Fork 本專案
2. 創建功能分支 (`git checkout -b feature/新功能`)
3. 提交更改 (`git commit -am '新增某功能'`)
4. 推送到分支 (`git push origin feature/新功能`)
5. 創建 Pull Request

## 📄 授權

本專案使用 MIT 授權條款 - 詳見 [LICENSE](LICENSE) 檔案

## 📞 支援

如果您遇到問題或有功能建議，請：
1. 查看 [Issues](../../issues) 是否已有相關討論
2. 創建新的 Issue 描述您的問題
3. 查看專案的說明文件和測試範例

## 🌟 致謝

- 感謝中央氣象署提供開放資料 API
- 感謝經濟部水利署提供水利防災資訊 API
- 感謝交通部高速公路局提供路況監視器 API
- 感謝 Discord.py 開發團隊
- 感謝所有貢獻者和使用者的回饋

---

**最後更新**: 2025年6月30日  
**版本**: v5.0  
**維護狀態**: 🟢 積極維護  
**功能狀態**: ✅ 所有核心功能正常運作
