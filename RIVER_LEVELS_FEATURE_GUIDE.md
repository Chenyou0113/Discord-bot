# 河川水位查詢指令 - 新功能說明

## 🌊 新增指令：`/river_levels`

### 功能概述
新增了河川水位監測查詢功能，可以查詢全台各地河川的即時水位資料。

### API 資料來源
- **API URL**: `https://opendata.wra.gov.tw/Service/OpenData.aspx?format=json&id=2D09DB8B-6A1B-485E-88B5-923A462F475C`
- **資料來源**: 經濟部水利署 - 河川水位監測系統
- **更新頻率**: 即時資料

## 📋 指令使用方法

### 1. 查看全台概覽
```
/river_levels
```
- 顯示各縣市監測點分布
- 顯示主要河川監測點統計
- 提供使用方法說明

### 2. 查詢特定地區
```
/river_levels location:台南
/river_levels location:高雄
/river_levels location:台北
```
- 顯示該地區所有河川水位監測點
- 包含監測點名稱、河川、水位、觀測時間

### 3. 查詢特定河川
```
/river_levels river_name:曾文溪
/river_levels river_name:高屏溪
/river_levels river_name:淡水河
```
- 顯示該河川沿線所有監測點
- 包含詳細的水位資訊

### 4. 雙重條件查詢
```
/river_levels location:台南 river_name:曾文溪
```
- 同時指定地區和河川名稱
- 獲得更精確的查詢結果

## 🎯 功能特色

### 1. 智能顯示模式
- **單一監測點**: 顯示詳細資訊（水位、觀測時間、位置、海拔等）
- **多個監測點**: 顯示列表概覽（最多12個）
- **統計概覽**: 顯示各縣市和河川的監測點分布

### 2. 完整資訊顯示
- 📍 **監測點名稱**
- 📍 **所在縣市**
- 🌊 **河川名稱**
- 💧 **當前水位** (公尺)
- 🕐 **觀測時間**
- 📋 **測站代碼**
- 📏 **海拔高度**
- 📍 **位置描述**

### 3. 資料處理優化
- 自動格式化水位數值 (保留2位小數)
- 智能時間顯示格式
- UTF-8 BOM 處理
- 錯誤處理機制

## 📊 資料範例

### 單一監測點詳細資訊
```
🌊 台南市安南大橋
📍 台南市 | 🌊 曾文溪

💧 水位資訊
當前水位: 2.35 公尺
觀測時間: 2025-06-29 15:30

📋 測站資訊
測站代碼: 01A550
位置描述: 台南市安南區安南大橋下游500公尺處

📏 海拔高度: 8.5 公尺
```

### 多監測點列表顯示
```  
🌊 河川水位監測點
找到 5 個台南相關的監測點

1. 台南市安南大橋
🌊 曾文溪
📍 台南市
💧 2.35 公尺
🕐 2025-06-29 15:30

2. 台南市麻豆大橋
🌊 曾文溪
📍 台南市
💧 1.87 公尺
🕐 2025-06-29 15:30
```

## 🔧 技術實作詳情

### 新增的函數

#### 1. `get_river_water_level_data()`
- 從 API 獲取河川水位資料
- 處理 SSL 連線和 UTF-8 BOM
- 錯誤處理和日誌記錄

#### 2. `format_river_water_level_info()`
- 格式化原始 API 資料
- 處理時間格式和數值格式
- 提供結構化的資料輸出

#### 3. `river_water_levels()` (指令主函數)
- Discord 斜線指令實作
- 支援多種查詢模式
- 智能結果顯示

### 資料欄位對應
```python
API 欄位                -> 顯示名稱
StationName            -> 監測點名稱
CountyName             -> 縣市
RiverName              -> 河川名稱
WaterLevel             -> 水位 (格式化為公尺)
ObservationTime        -> 觀測時間 (格式化)
StationIdentifier      -> 測站代碼
LocationDescription    -> 位置描述
StationAltitude        -> 海拔高度
```

## 📁 相關檔案

### 主要功能檔案
- `cogs/reservoir_commands.py` - 主要指令實作

### 測試檔案
- `test_river_water_level_api.py` - API 資料結構測試
- `test_river_levels_command.py` - 指令功能測試

### 說明文件
- `RIVER_LEVELS_FEATURE_GUIDE.md` - 本說明文件

## 🚀 部署說明

### 1. 指令已自動註冊
新指令已加入到 `ReservoirCommands` Cog 中，機器人重啟後會自動註冊。

### 2. 權限要求
- 無特殊權限要求
- 所有用戶都可使用

### 3. 相依性
- 使用現有的 `aiohttp` 和 `discord.py` 套件
- 無需額外安裝套件

## 💡 使用建議

### 1. 查詢策略
- 先使用 `/river_levels` 查看整體概覽
- 再針對感興趣的地區或河川進行詳細查詢
- 使用雙重條件獲得精確結果

### 2. 監測重點
- 關注水位變化趨勢
- 注意觀測時間的時效性
- 參考海拔高度了解地理位置

### 3. 搭配使用
- 可與 `/water_cameras` 監視器功能搭配
- 結合 `/reservoir_list` 水庫資訊全面了解水情

## 🔍 故障排除

### 1. 無法獲取資料
- 檢查網路連線
- 確認 API 服務正常
- 查看機器人日誌

### 2. 查詢無結果
- 檢查關鍵字拼寫
- 嘗試更寬泛的搜尋條件
- 使用 `/river_levels` 查看可用選項

### 3. 格式異常
- 部分監測點可能暫時無資料
- 時間格式可能因 API 變化而異
- 查看詳細錯誤日誌

## 📈 未來擴展

### 可能的功能增強
1. **歷史資料查詢** - 加入時間範圍查詢
2. **警戒水位提醒** - 設定水位閾值通知
3. **趨勢圖表** - 顯示水位變化圖表
4. **定期監控** - 自動定時推送水位報告

---

**河川水位查詢功能已成功整合到 Discord 機器人中，為用戶提供完整的水情監測服務！** 🌊
